name: CI
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  go_checks:
    name: Go checks
    uses: elastiflow/gha-reusable/.github/workflows/reusable_go_checks.yml@v0
    with:
      unit_test_cmd: make test-unit
      unit_test_report_coverage_cmd: make test-unit-enforce-coverage
      go_version_file: "go.mod"

  renovate_config_validator:
    name: Renovate config validator
    runs-on: ubuntu-latest
    container:
      image: renovate/renovate:latest
      options: --user root # root is needed for checkout to work
    steps:
      - uses: actions/checkout@v4
      - name: Validate Renovate config
        run: renovate-config-validator --strict


  all_checks:
    name: All Checks
    if: always()
    runs-on: ubuntu-latest
    needs:
      - go_checks
    steps:
      - name: Check if all checks passed
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
        with:
          jobs: ${{ toJSON(needs) }}
