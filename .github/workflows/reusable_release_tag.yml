on:
  workflow_call:
    inputs:
      tag_prefix:
        type: string
        default: "v"
        description: "Prefix to prepend to the tag"
      tag_suffix:
        type: string
        default: ""
        description: "Suffix to append to the tag, useful for RC releases, etc"
      push_minor_tag:
        type: boolean
        default: false
        description: "If true, push a major tag (vX.Y) in addition to the semver tag"
      push_major_tag:
        type: boolean
        default: false
        description: "If true, push a major tag (vX) in addition to the semver tag"
    secrets:
      custom_github_token:
        required: false
        description: "Token for the repo, useful when tag release event needs to trigger another workflow in the same repo"
    outputs:
      version:
        description: The version string generated by action
        value: ${{ jobs.release_tag.outputs.version }}
      version_tag:
        description: String identifier that would be used to tag the current commit as the "released" version. Typically this would only be used to generate a Git tag name
        value: ${{ jobs.release_tag.outputs.version_tag }}

env:
  TAG_SUFFIX_DELIMITER: ${{ inputs.tag_suffix && '-' || ''}}

jobs:
  release_tag:
    name: release a tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver.outputs.version }}
      version_tag: ${{ steps.semver.outputs.version_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Bump semver
        id: semver
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: ${{ inputs.tag_prefix }}
          namespace: ${{ inputs.tag_suffix }}
      - name: Create and push semver tag
        uses: elastiflow/gha-github-tag-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.custom_github_token || secrets.GITHUB_TOKEN }}
          CUSTOM_TAG: ${{ steps.semver.outputs.version_tag }}
      - name: Create and push minor tag
        if: ${{ inputs.push_minor_tag }}
        uses: elastiflow/gha-github-tag-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.custom_github_token || secrets.GITHUB_TOKEN }}
          TAG_IF_EXISTS: true
          GIT_API_TAGGING: false # not using API causes force push, which is needed to overwrite existing tag
          CUSTOM_TAG: "${{ inputs.tag_prefix }}${{ steps.semver.outputs.major }}.${{ steps.semver.outputs.minor }}${{ env.TAG_SUFFIX_DELIMITER }}${{ inputs.tag_suffix }}"
      - name: Create and push major tag
        if: ${{ inputs.push_major_tag }}
        uses: elastiflow/gha-github-tag-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.custom_github_token || secrets.GITHUB_TOKEN }}
          TAG_IF_EXISTS: true
          GIT_API_TAGGING: false # not using API causes force push, which is needed to overwrite existing tag
          CUSTOM_TAG: "${{ inputs.tag_prefix }}${{ steps.semver.outputs.major }}${{ env.TAG_SUFFIX_DELIMITER }}${{ inputs.tag_suffix }}"
